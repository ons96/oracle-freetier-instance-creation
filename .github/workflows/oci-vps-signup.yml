name: Oracle Always-Free VPS Signup

on:
  workflow_dispatch:
    inputs:
      availability_domain:
        description: 'Availability Domain'
        required: false
        default: 'AD-1'
        type: choice
        options:
          - AD-1
          - AD-2
          - AD-3
      boot_volume_size:
        description: 'Boot volume size (Max 50GB for safety, default 50)'
        required: false
        default: '50'
        type: string
      instance_name:
        description: 'Instance display name'
        required: false
        default: 'github-actions-ampere-instance'
        type: string
  schedule:
    - cron: '0 3 * * *' # 3 AM UTC
    - cron: '0 9 * * *' # 9 AM UTC
    - cron: '0 15 * * *' # 3 PM UTC
    - cron: '0 21 * * *' # 9 PM UTC

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  oracle-signup:
    if: ${{ github.event_name != 'schedule' || vars.OCI_AUTOSTOP != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Verify All Required Secrets
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
        run: |
          set -euo pipefail

          echo "Verifying all required secrets..."
          required=("OCI_USER_ID" "OCI_TENANCY_ID" "OCI_FINGERPRINT" "OCI_PRIVATE_KEY" "OCI_REGION")
          missing=0

          for name in "${required[@]}"; do
            if [ -z "${!name:-}" ]; then
              echo "Missing secret: ${name}"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            echo "Add missing secrets in: Settings → Secrets and variables → Actions"
            exit 1
          fi

          echo "All required secrets are set"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create OCI directory
        run: mkdir -p ~/.oci

      - name: Setup OCI configuration
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
        run: |
          set -euo pipefail

          echo "=== Creating OCI Configuration ==="
          echo "OCI_USER_ID (first 12 chars): ${OCI_USER_ID:0:12}..."
          echo "OCI_TENANCY_ID (first 12 chars): ${OCI_TENANCY_ID:0:12}..."
          echo "OCI_FINGERPRINT (first 12 chars): ${OCI_FINGERPRINT:0:12}..."
          echo "OCI_REGION: ${OCI_REGION}"
          echo "OCI_PRIVATE_KEY length: ${#OCI_PRIVATE_KEY}"

          cat > ~/.oci/config <<CONFIG_EOF
          [DEFAULT]
          user=${OCI_USER_ID}
          fingerprint=${OCI_FINGERPRINT}
          key_file=~/.oci/oci_private_key.pem
          tenancy=${OCI_TENANCY_ID}
          region=${OCI_REGION}
          CONFIG_EOF

          printf '%s' "$OCI_PRIVATE_KEY" > ~/.oci/oci_private_key.pem
          chmod 600 ~/.oci/oci_private_key.pem

          echo ""
          echo "=== Verifying OCI Configuration ==="
          if [ -f ~/.oci/config ]; then
            echo "Config file created"
            echo "Config content (redacted):"
            sed -E \
              -e 's/^(user=).+$/\1[REDACTED]/' \
              -e 's/^(tenancy=).+$/\1[REDACTED]/' \
              ~/.oci/config
          else
            echo "Config file NOT created"
            exit 1
          fi

      - name: Validate boot volume size
        env:
          BOOT_VOLUME_SIZE: ${{ github.event.inputs.boot_volume_size || '50' }}
        run: |
          set -euo pipefail

          boot_size="${BOOT_VOLUME_SIZE}"
          if ! [[ "$boot_size" =~ ^[0-9]+$ ]]; then
            echo "Boot volume size must be a whole number of GB. Got: '$boot_size'"
            exit 1
          fi

          if [ "$boot_size" -gt 100 ]; then
            echo "Boot volume size ${boot_size}GB exceeds 100GB safety limit"
            echo "For Always-Free safety, use 50GB unless you know your tenancy's exact free storage constraints."
            exit 1
          fi

          echo "Boot volume size valid: ${boot_size}GB"

      - name: Create instance
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCT_FREE_AD: ${{ github.event.inputs.availability_domain || 'AD-1' }}
          DISPLAY_NAME: ${{ github.event.inputs.instance_name || 'github-actions-ampere-instance' }}
          OCI_COMPUTE_SHAPE: VM.Standard.A1.Flex
          BOOT_VOLUME_SIZE: ${{ github.event.inputs.boot_volume_size || '50' }}
          OPERATING_SYSTEM: Canonical Ubuntu
          OS_VERSION: '22.04'
          ASSIGN_PUBLIC_IP: 'false'
          SECOND_MICRO_INSTANCE: 'false'
          CI: 'true'
          GITHUB_ACTIONS: 'true'
        run: |
          set -euo pipefail

          echo "Starting instance creation..."
          echo "AD: ${OCT_FREE_AD} | Boot: ${BOOT_VOLUME_SIZE}GB | Region: ${OCI_REGION}"

          # Expand $HOME in path (environment variables don't expand in GitHub Actions)
          OCI_CONFIG="${HOME}/.oci/config"

          if [ ! -f "${OCI_CONFIG}" ]; then
            echo "OCI config file not found at: ${OCI_CONFIG}"
            exit 1
          fi

          python main.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instance-logs
          path: |
            INSTANCE_CREATED
            MAX_RUNTIME_REACHED
            setup_and_info.log
            launch_instance.log
            ERROR_IN_CONFIG.log
            UNHANDLED_ERROR.log
          retention-days: 30

      - name: Show results
        if: always()
        run: |
          set -euo pipefail

          echo "=== Results ==="
          if [ -f INSTANCE_CREATED ]; then
            echo "Instance created!"
            cat INSTANCE_CREATED
          elif [ -f MAX_RUNTIME_REACHED ]; then
            echo "Max runtime reached, no capacity yet"
            cat MAX_RUNTIME_REACHED
          else
            echo "Instance creation failed"
          fi

      - name: Auto-stop on success
        if: hashFiles('INSTANCE_CREATED') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function upsertRepoVariable(name, value) {
              try {
                await github.request('PATCH /repos/{owner}/{repo}/actions/variables/{name}', {
                  owner,
                  repo,
                  name,
                  value,
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.request('POST /repos/{owner}/{repo}/actions/variables', {
                    owner,
                    repo,
                    name,
                    value,
                  });
                } else {
                  throw e;
                }
              }
            }

            await upsertRepoVariable('OCI_AUTOSTOP', 'true');

            const fs = require('fs');
            const details = fs.readFileSync('INSTANCE_CREATED', 'utf8');
            await github.rest.issues.create({
              owner,
              repo,
              title: '✅ Oracle Always-Free VPS Created',
              body: `Instance has been successfully created!\n\n\`\`\`\n${details}\n\`\`\`\n\nScheduled runs have been auto-disabled by setting repository variable OCI_AUTOSTOP=true.`,
              assignees: [context.actor],
            });

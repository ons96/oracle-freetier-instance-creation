name: Oracle Always-Free VPS Signup (Verified $0.00/month)

on:
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 9 * * *'
    - cron: '0 15 * * *'
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      availability_domain:
        description: 'Availability Domain'
        required: false
        default: 'AD-1'
        type: choice
        options:
          - AD-1
          - AD-2
          - AD-3
      subnet_id:
        description: 'Subnet ID (optional, leave empty for auto-detect)'
        required: false
        default: ''
        type: string
      image_id:
        description: 'Custom Image ID (optional, leave empty to auto-detect)'
        required: false
        default: ''
        type: string
      instance_name:
        description: 'Instance display name'
        required: false
        default: 'github-actions-ampere-instance'
        type: string
      boot_volume_size:
        description: 'Boot volume size (Max 200GB Always-Free limit)'
        required: false
        default: '50'
        type: string
      max_runtime_minutes:
        description: 'Max runtime per run (minutes). 0 = unlimited. Scheduled runs default to 20.'
        required: false
        default: '0'
        type: string

permissions:
  contents: read
  issues: write
  actions: write

concurrency:
  group: oci-vps-signup
  cancel-in-progress: true

jobs:
  oracle-signup:
    # Auto-stop: once INSTANCE_CREATED happens, the workflow writes OCI_AUTOSTOP=true
    # and future scheduled runs will skip (manual dispatch will still work).
    if: ${{ github.event_name != 'schedule' || vars.OCI_AUTOSTOP != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6-hour GHA limit

    steps:
      - name: "ðŸ” Verify Always-Free Tier Configuration"
        run: |
          echo "ðŸš¨ ALWAYS-FREE TIER VERIFICATION"
          echo "=================================="
          echo "Shape: VM.Standard.A1.Flex âœ“ (Ampere ARM, 4 OCPU, 24GB)"
          echo "Region: ca-toronto-1, us-ashburn-1, us-phoenix-1 âœ“"
          echo "Storage: Max 100GB boot volume (safe limit) âœ“"
          echo "OS: Canonical Ubuntu 22.04 âœ“"
          echo "Cost: $0.00/month guaranteed âœ“"
          echo "Multi-AD Retry: AD-1 â†’ AD-2 â†’ AD-3 âœ“"
          echo ""

          missing=0

          region="${{ secrets.OCI_REGION }}"
          if [ -n "$region" ]; then
            if [ "$region" = "ca-toronto-1" ] || [ "$region" = "us-ashburn-1" ] || [ "$region" = "us-phoenix-1" ]; then
              echo "OCI_REGION is Always-Free eligible âœ“"
            else
              echo "âŒ ERROR: OCI_REGION is not in the allowed Always-Free list (ca-toronto-1, us-ashburn-1, us-phoenix-1)"
              missing=1
            fi
          fi

          echo ""
          echo "âš ï¸  NEVER CHANGE THESE VALUES TO AVOID PAYG CHARGES"

          if [ -z "${{ secrets.OCI_USER_ID }}" ]; then
            echo "âŒ ERROR: OCI_USER_ID secret not set!"
            missing=1
          fi
          if [ -z "${{ secrets.OCI_TENANCY_ID }}" ]; then
            echo "âŒ ERROR: OCI_TENANCY_ID secret not set!"
            missing=1
          fi
          if [ -z "${{ secrets.OCI_FINGERPRINT }}" ]; then
            echo "âŒ ERROR: OCI_FINGERPRINT secret not set!"
            missing=1
          fi
          if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: OCI_PRIVATE_KEY secret not set!"
            missing=1
          fi
          if [ -z "${{ secrets.OCI_REGION }}" ]; then
            echo "âŒ ERROR: OCI_REGION secret not set!"
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create OCI config directory
        run: mkdir -p ~/.oci

      - name: Setup OCI configuration
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
        run: |
          echo "=== DEBUG: OCI Environment Variables ==="
          echo "OCI_USER_ID length: ${#OCI_USER_ID}"
          echo "OCI_TENANCY_ID length: ${#OCI_TENANCY_ID}"
          echo "OCI_FINGERPRINT length: ${#OCI_FINGERPRINT}"
          echo "OCI_REGION: $OCI_REGION"
          echo "OCI_PRIVATE_KEY length: ${#OCI_PRIVATE_KEY}"

          # Validate that all required variables are set
          if [ -z "$OCI_USER_ID" ] || [ -z "$OCI_TENANCY_ID" ] || [ -z "$OCI_FINGERPRINT" ] || [ -z "$OCI_REGION" ] || [ -z "$OCI_PRIVATE_KEY" ]; then
            echo "âŒ ERROR: One or more OCI secrets are empty!"
            exit 1
          fi

          mkdir -p ~/.oci

          # Create OCI config file with proper validation
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=$OCI_USER_ID
          fingerprint=$OCI_FINGERPRINT
          key_file=$HOME/.oci/oci_private_key.pem
          tenancy=$OCI_TENANCY_ID
          region=$OCI_REGION
          EOF

          # Debug: verify the config was created with proper values
          echo "=== OCI Config Content ==="
          cat ~/.oci/config
          echo "=== End OCI Config ==="

          # Create private key file
          printf '%s' "$OCI_PRIVATE_KEY" > ~/.oci/oci_private_key.pem
          chmod 600 ~/.oci/oci_private_key.pem

          # Verify private key was created
          echo "=== Private Key Info ==="
          ls -la ~/.oci/oci_private_key.pem
          echo "Private key file created successfully"

      - name: Configure max runtime
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "MAX_RUNTIME_SECS=1200" >> "$GITHUB_ENV"  # 20 minutes per scheduled run
          else
            mins="${{ github.event.inputs.max_runtime_minutes || '0' }}"
            if echo "$mins" | grep -Eq '^[0-9]+$' && [ "$mins" -gt 0 ]; then
              echo "MAX_RUNTIME_SECS=$((mins * 60))" >> "$GITHUB_ENV"
            else
              echo "MAX_RUNTIME_SECS=0" >> "$GITHUB_ENV"
            fi
          fi

      - name: Verify OCI configuration
        run: |
          echo "Checking OCI configuration..."
          ls -la ~/.oci/
          echo "OCI config content:"
          cat ~/.oci/config
          echo "MAX_RUNTIME_SECS=${MAX_RUNTIME_SECS}"

      - name: Create instance with OCI
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_CONFIG: ~/.oci/config
          OCT_FREE_AD: ${{ github.event.inputs.availability_domain || 'AD-1' }}
          DISPLAY_NAME: ${{ github.event.inputs.instance_name || 'github-actions-arm-instance' }}
          OCI_COMPUTE_SHAPE: "VM.Standard.A1.Flex"
          OCI_SUBNET_ID: ${{ github.event.inputs.subnet_id || '' }}
          OCI_IMAGE_ID: ${{ github.event.inputs.image_id || '' }}
          OPERATING_SYSTEM: "Canonical Ubuntu"
          OS_VERSION: "22.04"
          ASSIGN_PUBLIC_IP: "false"
          BOOT_VOLUME_SIZE: ${{ github.event.inputs.boot_volume_size || '50' }}
          SECOND_MICRO_INSTANCE: "false"
          REQUEST_WAIT_TIME_SECS: "60"
          SSH_AUTHORIZED_KEYS_FILE: "id_rsa.pub"
          CI: true
          GITHUB_ACTIONS: true
        run: |
          echo "=== DEBUG: Environment Variables for main.py ==="
          echo "OCI_CONFIG: $OCI_CONFIG"
          echo "OCT_FREE_AD: $OCT_FREE_AD"
          echo "BOOT_VOLUME_SIZE: $BOOT_VOLUME_SIZE"
          echo "OCI_COMPUTE_SHAPE: $OCI_COMPUTE_SHAPE"

          # Verify OCI config file exists and has content
          if [ -f "$OCI_CONFIG" ]; then
            echo "âœ… OCI config file exists at: $OCI_CONFIG"
            echo "OCI config content:"
            cat "$OCI_CONFIG"
          else
            echo "âŒ ERROR: OCI config file not found at: $OCI_CONFIG"
            exit 1
          fi

          echo "Starting OCI instance creation..."
          python main.py

      - name: Upload instance details
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instance-details
          path: |
            INSTANCE_CREATED
            MAX_RUNTIME_REACHED
            setup_and_info.log
            launch_instance.log
            ERROR_IN_CONFIG.log
            UNHANDLED_ERROR.log
            images_list.json
            id_rsa.pub
          retention-days: 30

      - name: Display results
        if: always()
        run: |
          echo "=== Instance Creation Results ==="
          if [ -f "INSTANCE_CREATED" ]; then
            echo "âœ… Instance created successfully!"
            cat INSTANCE_CREATED
          elif [ -f "MAX_RUNTIME_REACHED" ]; then
            echo "â±ï¸ Max runtime reached; no instance created yet."
            cat MAX_RUNTIME_REACHED
          else
            echo "âŒ Instance creation failed"
          fi

          echo ""
          echo "=== Log Files (tail) ==="
          if [ -f "setup_and_info.log" ]; then
            echo "Setup log:"
            tail -20 setup_and_info.log
          fi

          if [ -f "launch_instance.log" ]; then
            echo "Launch log:"
            tail -20 launch_instance.log
          fi

      - name: Write workflow summary
        if: always()
        run: |
          {
            echo "## Oracle Always-Free VPS Signup"
            echo ""
            echo "- Trigger: \`${{ github.event_name }}\`"
            echo "- Auto-stop variable (OCI_AUTOSTOP): \`${{ vars.OCI_AUTOSTOP || 'not set' }}\`"
            echo "- OCI_REGION secret: \`${{ secrets.OCI_REGION != '' && 'set' || 'missing' }}\`"
            echo "- MAX_RUNTIME_SECS: \`${MAX_RUNTIME_SECS}\`"
            echo "- Multi-AD Retry: AD-1 â†’ AD-2 â†’ AD-3 (automatic)"
            echo "- Boot Volume Limit: 100GB (safe Always-Free limit)"
            echo ""

            if [ -f "INSTANCE_CREATED" ]; then
              echo "### âœ… Instance created"
              echo "\`INSTANCE_CREATED\` contents:"
              echo "```"
              cat INSTANCE_CREATED
              echo "```"
            elif [ -f "MAX_RUNTIME_REACHED" ]; then
              echo "### â±ï¸ No capacity yet"
              echo "This scheduled run stopped after the configured max runtime."
              echo "The workflow automatically tried all availability domains (AD-1, AD-2, AD-3) before giving up."
              echo "```"
              cat MAX_RUNTIME_REACHED
              echo "```"
            else
              echo "### âŒ Instance not created"
              echo "Check artifacts for logs."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Auto-stop future scheduled runs + notify via GitHub issue
        if: ${{ hashFiles('INSTANCE_CREATED') != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function upsertRepoVariable(name, value) {
              try {
                await github.request('PATCH /repos/{owner}/{repo}/actions/variables/{name}', {
                  owner,
                  repo,
                  name,
                  value,
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.request('POST /repos/{owner}/{repo}/actions/variables', {
                    owner,
                    repo,
                    name,
                    value,
                  });
                } else {
                  throw e;
                }
              }
            }

            const details = fs.readFileSync('INSTANCE_CREATED', 'utf8').trim();
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = 'âœ… OCI Always-Free VPS created';
            const body = [
              'An Oracle Always-Free VPS instance has been created.',
              '',
              `Workflow run: ${runUrl}`,
              '',
              'Instance details:',
              '```',
              details,
              '```',
              '',
              'Auto-stop has been enabled by setting repository variable `OCI_AUTOSTOP=true`.',
              'To re-enable scheduled attempts: delete the variable or set it to `false` under Settings â†’ Secrets and variables â†’ Actions â†’ Variables.',
            ].join('\n');

            // 1) Auto-stop future scheduled runs
            await upsertRepoVariable('OCI_AUTOSTOP', 'true');

            // 2) Create (or update) an issue to trigger GitHub email notifications
            const assignee = context.actor;
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                assignees: [assignee],
              });
            }

name: Oracle Always-Free VPS Signup (Verified $0.00/month)

on:
  workflow_dispatch:
    inputs:
      verify_free_tier:
        description: 'Verify Always-Free tier before execution (recommended)'
        required: true
        default: 'true'
        type: boolean
      availability_domain:
        description: 'Availability Domain'
        required: false
        default: 'AD-1'
        type: string
        enum: ['AD-1', 'AD-2', 'AD-3']
      subnet_id:
        description: 'Subnet ID (optional, leave empty for auto-detect)'
        required: false
        default: ''
        type: string
      image_id:
        description: 'Custom Image ID (optional, leave empty to auto-detect)'
        required: false
        default: ''
        type: string
      instance_name:
        description: 'Instance display name'
        required: false
        default: 'github-actions-ampere-instance'
        type: string
      boot_volume_size:
        description: 'Boot volume size (Max 200GB Always-Free limit)'
        required: false
        default: '50'
        type: string

jobs:
  oracle-signup:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6-hour GHA limit
    
    steps:
    # Step 1: Verify free-tier configuration
    - name: "üîç Verify Always-Free Tier Configuration"
      run: |
        echo "üö® ALWAYS-FREE TIER VERIFICATION"
        echo "=================================="
        echo "Shape: VM.Standard.A1.Flex ‚úì (Ampere ARM, 4 OCPU, 24GB)"
        echo "Region: us-ashburn-1 or us-phoenix-1 ‚úì"
        echo "Storage: Max 200GB total ‚úì"
        echo "OS: Canonical Ubuntu 22.04 ‚úì"
        echo "Cost: $0.00/month guaranteed ‚úì"
        echo ""
        echo "‚ö†Ô∏è  NEVER CHANGE THESE VALUES TO AVOID PAYG CHARGES"
        
        # Fail if critical secrets missing
        if [ -z "${{ secrets.OCI_PRIVATE_KEY }}" ]; then
          echo "‚ùå ERROR: OCI_PRIVATE_KEY secret not set!"
          exit 1
        fi
    
    # Step 2: Checkout code
    - name: "üì¶ Checkout Repository"
      uses: actions/checkout@v4
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create OCI config directory
      run: mkdir -p ~/.oci
    
    - name: Setup OCI configuration
      env:
        OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
        OCI_TENANCY_ID: ${{ secrets.OCI_TENANCY_ID }}
        OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
        OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
        OCI_REGION: ${{ secrets.OCI_REGION }}
      run: |
        cat > ~/.oci/config << EOF
        [DEFAULT]
        user=$OCI_USER_ID
        fingerprint=$OCI_FINGERPRINT
        key_file=~/.oci/oci_private_key.pem
        tenancy=$OCI_TENANCY_ID
        region=$OCI_REGION
        EOF
        
        echo "$OCI_PRIVATE_KEY" > ~/.oci/oci_private_key.pem
        chmod 600 ~/.oci/oci_private_key.pem
    
    - name: Setup environment variables
      env:
        INSTANCE_NAME: ${{ github.event.inputs.instance_name || 'github-actions-arm-instance' }}
        COMPUTE_SHAPE: ${{ github.event.inputs.compute_shape || 'VM.Standard.A1.Flex' }}
        AVAILABILITY_DOMAIN: ${{ github.event.inputs.availability_domain || 'AD-1' }}
        SUBNET_ID: ${{ github.event.inputs.subnet_id || '' }}
        IMAGE_ID: ${{ github.event.inputs.image_id || '' }}
        ENABLE_NOTIFICATIONS: ${{ github.event.inputs.enable_notifications || 'false' }}
        OCI_CONFIG: ~/.oci/config
        OCT_FREE_AD: ${{ github.event.inputs.availability_domain || 'AD-1' }}
        DISPLAY_NAME: ${{ github.event.inputs.instance_name || 'github-actions-arm-instance' }}
        OCI_COMPUTE_SHAPE: ${{ github.event.inputs.compute_shape || 'VM.Standard.A1.Flex' }}
        OCI_SUBNET_ID: ${{ github.event.inputs.subnet_id || '' }}
        OCI_IMAGE_ID: ${{ github.event.inputs.image_id || '' }}
        NOTIFY_EMAIL: ${{ github.event.inputs.enable_notifications || 'false' }}
        EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        CI: true
        GITHUB_ACTIONS: true
      run: |
        echo "INSTANCE_NAME=$INSTANCE_NAME" >> $GITHUB_ENV
        echo "COMPUTE_SHAPE=$COMPUTE_SHAPE" >> $GITHUB_ENV
        echo "Setting up CI environment variables"
    
    - name: Verify OCI configuration
      run: |
        echo "Checking OCI configuration..."
        ls -la ~/.oci/
        echo "OCI config content:"
        cat ~/.oci/config
    
    - name: Create instance with OCI
      env:
        OCI_CONFIG: ~/.oci/config
        OCT_FREE_AD: ${{ github.event.inputs.availability_domain || 'AD-1' }}
        DISPLAY_NAME: ${{ github.event.inputs.instance_name || 'github-actions-arm-instance' }}
        OCI_COMPUTE_SHAPE: ${{ github.event.inputs.compute_shape || 'VM.Standard.A1.Flex' }}
        OCI_SUBNET_ID: ${{ github.event.inputs.subnet_id || '' }}
        OCI_IMAGE_ID: ${{ github.event.inputs.image_id || '' }}
        OPERATING_SYSTEM: "Canonical Ubuntu"
        OS_VERSION: "22.04"
        ASSIGN_PUBLIC_IP: "false"
        BOOT_VOLUME_SIZE: "50"
        SECOND_MICRO_INSTANCE: "false"
        REQUEST_WAIT_TIME_SECS: "60"
        SSH_AUTHORIZED_KEYS_FILE: "id_rsa.pub"
        NOTIFY_EMAIL: ${{ github.event.inputs.enable_notifications || 'false' }}
        EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        CI: true
        GITHUB_ACTIONS: true
      run: |
        echo "Starting OCI instance creation..."
        python main.py
    
    - name: Upload instance details
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: instance-details
        path: |
          INSTANCE_CREATED
          setup_and_info.log
          launch_instance.log
          ERROR_IN_CONFIG.log
          UNHANDLED_ERROR.log
          images_list.json
          id_rsa.pub
        retention-days: 30
    
    - name: Display results
      if: always()
      run: |
        echo "=== Instance Creation Results ==="
        if [ -f "INSTANCE_CREATED" ]; then
          echo "‚úÖ Instance created successfully!"
          cat INSTANCE_CREATED
        else
          echo "‚ùå Instance creation failed or in progress"
        fi
        
        echo ""
        echo "=== Log Files ==="
        if [ -f "setup_and_info.log" ]; then
          echo "Setup log:"
          tail -20 setup_and_info.log
        fi
        
        if [ -f "launch_instance.log" ]; then
          echo "Launch log:"
          tail -20 launch_instance.log
        fi